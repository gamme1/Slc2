<!DOCTYPE html>
<html>
<head>
    <title>SolCam - Video Calls</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            background: linear-gradient(to right, #8b5cf6, #ec4899);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .tagline {
            color: #94a3b8;
            font-size: 1.2rem;
            margin-bottom: 30px;
        }
        
        .role-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .role-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        #userBtn {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        
        #modelBtn {
            background: linear-gradient(to right, #8b5cf6, #ec4899);
            color: white;
        }
        
        .role-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        .role-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .video-box {
            flex: 1;
            min-width: 300px;
            background: #1e293b;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .video-box h3 {
            margin-bottom: 15px;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        video {
            width: 100%;
            border-radius: 10px;
            background: #0f172a;
        }
        
        #localVideo {
            border: 3px solid #10b981;
        }
        
        #remoteVideo {
            border: 3px solid #ec4899;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        #goLiveBtn {
            background: linear-gradient(to right, #ec4899, #8b5cf6);
            color: white;
        }
        
        #connectBtn {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
        }
        
        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #endCallBtn {
            background: #ef4444;
            color: white;
        }
        
        .status-bar {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            border-left: 4px solid #8b5cf6;
        }
        
        #status {
            font-size: 1.1rem;
            color: #e2e8f0;
        }
        
        .online-count {
            background: rgba(16, 185, 129, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            color: #10b981;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .video-container {
                flex-direction: column;
            }
            
            .video-box {
                min-width: 100%;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .control-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• SolCam 1v1</h1>
            <p class="tagline">Real-time video calling platform</p>
            
            <div class="role-selector">
                <button id="userBtn" class="role-btn">üë§ I'm a User</button>
                <button id="modelBtn" class="role-btn">üé¨ I'm a Model</button>
            </div>
        </header>
        
        <!-- User Interface -->
        <div id="userInterface" class="main-content">
            <div class="video-container">
                <div class="video-box">
                    <h3>üìπ Model's Camera <span id="modelStatus" style="color:#94a3b8; font-size:0.9rem;">(Waiting...)</span></h3>
                    <video id="remoteVideoUser" autoplay playsinline></video>
                </div>
                <div class="video-box">
                    <h3>üë§ Your Camera</h3>
                    <video id="localVideoUser" autoplay muted playsinline></video>
                </div>
            </div>
            
            <div class="controls">
                <button id="connectBtn" class="control-btn" onclick="connectToModel()">
                    üîó Connect to Model
                </button>
                <button id="toggleMicUser" class="control-btn" onclick="toggleMic()">
                    üé§ Mute Mic
                </button>
                <button id="toggleCamUser" class="control-btn" onclick="toggleCamera()">
                    üì∑ Turn Off Camera
                </button>
                <button id="endCallUser" class="control-btn" onclick="endCall()" disabled>
                    ‚ùå End Call
                </button>
            </div>
            
            <div class="status-bar">
                <div id="status">‚úÖ Ready to connect. Select your role above.</div>
                <div class="online-count">
                    üë• <span id="onlineCount">0</span> people online
                </div>
            </div>
        </div>
        
        <!-- Model Interface -->
        <div id="modelInterface" class="main-content">
            <div class="video-container">
                <div class="video-box">
                    <h3>üë§ User's Camera <span id="userStatus" style="color:#94a3b8; font-size:0.9rem;">(Waiting...)</span></h3>
                    <video id="remoteVideoModel" autoplay playsinline></video>
                </div>
                <div class="video-box">
                    <h3>üé¨ Your Camera</h3>
                    <video id="localVideoModel" autoplay muted playsinline></video>
                </div>
            </div>
            
            <div class="controls">
                <button id="goLiveBtn" class="control-btn" onclick="goLive()">
                    üé¨ GO LIVE NOW
                </button>
                <button id="toggleMicModel" class="control-btn" onclick="toggleMic()">
                    üé§ Mute Mic
                </button>
                <button id="toggleCamModel" class="control-btn" onclick="toggleCamera()">
                    üì∑ Turn Off Camera
                </button>
                <button id="endCallModel" class="control-btn" onclick="endCall()" disabled>
                    ‚ùå End Call
                </button>
            </div>
            
            <div class="status-bar">
                <div id="modelStatusText">üé¨ You are a Model. Click GO LIVE to start earning!</div>
                <div class="online-count">
                    üí∞ Earnings: $<span id="earnings">0.00</span>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        const socket = io();
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentRole = null;
        let partnerId = null;
        let isCallActive = false;
        let isMicMuted = false;
        let isCameraOff = false;
        let earnings = 0;
        
        // WebRTC configuration
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };
        
        // DOM Elements
        const userInterface = document.getElementById('userInterface');
        const modelInterface = document.getElementById('modelInterface');
        const userBtn = document.getElementById('userBtn');
        const modelBtn = document.getElementById('modelBtn');
        const status = document.getElementById('status');
        const modelStatusText = document.getElementById('modelStatusText');
        const onlineCount = document.getElementById('onlineCount');
        const earningsDisplay = document.getElementById('earnings');
        
        // Initialize app
        async function init() {
            try {
                // Get camera and microphone access
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                // Set up local video for both interfaces
                document.getElementById('localVideoUser').srcObject = localStream;
                document.getElementById('localVideoModel').srcObject = localStream;
                
                updateStatus('‚úÖ Camera and microphone ready! Select your role.');
                
                // Socket.io event handlers
                setupSocketListeners();
                
                // Role selection
                userBtn.addEventListener('click', () => selectRole('user'));
                modelBtn.addEventListener('click', () => selectRole('model'));
                
            } catch (error) {
                console.error('Error accessing media devices:', error);
                updateStatus('‚ùå Please allow camera and microphone access to use SolCam.');
            }
        }
        
        function selectRole(role) {
            currentRole = role;
            
            // Update UI
            userBtn.classList.remove('active');
            modelBtn.classList.remove('active');
            
            if (role === 'user') {
                userBtn.classList.add('active');
                userInterface.classList.add('active');
                modelInterface.classList.remove('active');
                updateStatus('üë§ You are a User. Click "Connect to Model" to start a call.');
            } else {
                modelBtn.classList.add('active');
                modelInterface.classList.add('active');
                userInterface.classList.remove('active');
                updateModelStatus('üé¨ You are a Model. Click "GO LIVE NOW" to start accepting calls.');
            }
            
            // Register with server
            socket.emit('register', role);
        }
        
        function setupSocketListeners() {
            // Update online count
            socket.on('online-count', (count) => {
                onlineCount.textContent = count;
            });
            
            // Partner found
            socket.on('partner-found', (data) => {
                partnerId = data.partnerId;
                updateStatus(`üéØ Connected with ${data.partnerType}! Starting call...`);
                
                if (currentRole === 'model') {
                    updateModelStatus('üéØ User connected! Starting call...');
                }
                
                createPeerConnection();
                startCall();
            });
            
            // WebRTC signaling
            socket.on('offer', async (data) => {
                if (!peerConnection) createPeerConnection();
                
                await peerConnection.setRemoteDescription(
                    new RTCSessionDescription(data.offer)
                );
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('answer', {
                    answer: answer,
                    target: data.sender
                });
            });
            
            socket.on('answer', async (data) => {
                await peerConnection.setRemoteDescription(
                    new RTCSessionDescription(data.answer)
                );
            });
            
            socket.on('ice-candidate', async (candidate) => {
                try {
                    await peerConnection.addIceCandidate(
                        new RTCIceCandidate(candidate)
                    );
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            });
            
            // Partner disconnected
            socket.on('partner-disconnected', () => {
                if (currentRole === 'user') {
                    updateStatus('üìû Model disconnected. Ready to connect again.');
                } else {
                    updateModelStatus('üìû User disconnected. Ready for next call.');
                    // Add earnings for model
                    earnings += 5.00;
                    earningsDisplay.textContent = earnings.toFixed(2);
                }
                
                endCall();
            });
            
            // Error handling
            socket.on('error', (message) => {
                updateStatus(`‚ùå Error: ${message}`);
            });
        }
        
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local tracks
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Handle incoming stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                
                // Set remote video based on role
                if (currentRole === 'user') {
                    document.getElementById('remoteVideoUser').srcObject = remoteStream;
                } else {
                    document.getElementById('remoteVideoModel').srcObject = remoteStream;
                }
                
                // Update UI
                isCallActive = true;
                document.getElementById('endCallUser').disabled = false;
                document.getElementById('endCallModel').disabled = false;
                
                if (currentRole === 'user') {
                    updateStatus('‚úÖ Call connected! You can see and hear the model.');
                } else {
                    updateModelStatus('‚úÖ You are LIVE! User can see and hear you.');
                }
            };
            
            // ICE candidate handling
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && partnerId) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        target: partnerId
                    });
                }
            };
            
            // Connection state changes
            peerConnection.onconnectionstatechange = () => {
                console.log('Connection state:', peerConnection.connectionState);
            };
        }
        
        async function startCall() {
            if (!peerConnection) createPeerConnection();
            
            const offer = await peerConnection.createOffer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });
            
            await peerConnection.setLocalDescription(offer);
            
            if (partnerId) {
                socket.emit('offer', {
                    offer: offer,
                    target: partnerId
                });
                
                if (currentRole === 'user') {
                    updateStatus('üìû Calling model...');
                } else {
                    updateModelStatus('üìû Connecting to user...');
                }
            }
        }
        
        function connectToModel() {
            if (currentRole !== 'user') return;
            
            socket.emit('find-partner', 'user');
            updateStatus('üîç Searching for available models...');
        }
        
        function goLive() {
            if (currentRole !== 'model') return;
            
            socket.emit('find-partner', 'model');
            updateModelStatus('üîç Waiting for users to connect...');
        }
        
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                if (currentRole === 'user') {
                    document.getElementById('remoteVideoUser').srcObject = null;
                } else {
                    document.getElementById('remoteVideoModel').srcObject = null;
                }
                remoteStream = null;
            }
            
            isCallActive = false;
            partnerId = null;
            
            document.getElementById('endCallUser').disabled = true;
            document.getElementById('endCallModel').disabled = true;
            
            if (currentRole === 'user') {
                updateStatus('üìû Call ended. Ready to connect again.');
            } else {
                updateModelStatus('üìû Call ended. Click GO LIVE to accept new calls.');
            }
        }
        
        function toggleMic() {
            if (!localStream) return;
            
            const audioTracks = localStream.getAudioTracks();
            if (audioTracks.length > 0) {
                isMicMuted = !audioTracks[0].enabled;
                audioTracks[0].enabled = !isMicMuted;
                
                const micBtn = currentRole === 'user' 
                    ? document.getElementById('toggleMicUser')
                    : document.getElementById('toggleMicModel');
                
                micBtn.innerHTML = isMicMuted ? 'üé§ Unmute Mic' : 'üé§ Mute Mic';
                
                if (currentRole === 'user') {
                    updateStatus(isMicMuted ? 'üîá Mic muted' : 'üé§ Mic unmuted');
                } else {
                    updateModelStatus(isMicMuted ? 'üîá Mic muted' : 'üé§ Mic unmuted');
                }
            }
        }
        
        function toggleCamera() {
            if (!localStream) return;
            
            const videoTracks = localStream.getVideoTracks();
            if (videoTracks.length > 0) {
                isCameraOff = !videoTracks[0].enabled;
                videoTracks[0].enabled = !isCameraOff;
                
                const camBtn = currentRole === 'user'
                    ? document.getElementById('toggleCamUser')
                    : document.getElementById('toggleCamModel');
                
                camBtn.innerHTML = isCameraOff ? 'üì∑ Turn On Camera' : 'üì∑ Turn Off Camera';
                
                if (currentRole === 'user') {
                    updateStatus(isCameraOff ? 'üì∑ Camera off' : 'üì∑ Camera on');
                } else {
                    updateModelStatus(isCameraOff ? 'üì∑ Camera off' : 'üì∑ Camera on');
                }
            }
        }
        
        function updateStatus(message) {
            status.textContent = message;
        }
        
        function updateModelStatus(message) {
            modelStatusText.textContent = message;
        }
        
        // Initialize on page load
        window.onload = init;
    </script>
</body>
  </html>
