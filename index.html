<!DOCTYPE html>
<html>
<head>
    <title>SolCam - Video Call</title>
    <style>
        body { background: #0f172a; color: white; text-align: center; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .video-container { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
        video { width: 100%; max-width: 600px; border: 3px solid #475569; border-radius: 10px; }
        #localVideo { width: 200px; height: 150px; position: absolute; bottom: 20px; right: 20px; border: 2px solid #10b981; }
        .controls { margin: 20px; }
        button { 
            background: #10b981; color: white; border: none; padding: 12px 25px; 
            border-radius: 8px; margin: 10px; font-weight: bold; cursor: pointer;
        }
        button:hover { background: #059669; }
        .status { padding: 10px; background: #1e293b; border-radius: 8px; margin: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ SolCam - User</h1>
        <div class="status" id="status">Connecting to server...</div>
        
        <div class="video-container">
            <div>
                <h3>ğŸ“¹ Model's Camera</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="startCall()">ğŸ”— Connect to Model</button>
            <button onclick="toggleMute()">ğŸ”‡ Toggle Mic</button>
            <button onclick="toggleVideo()">ğŸ“· Toggle Camera</button>
            <button onclick="endCall()" style="background:#ef4444;">âŒ End Call</button>
        </div>
        
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let localStream;
        let remoteStream;
        let peerConnection;
        let isCallActive = false;
        
        // Configuration for WebRTC
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        // Initialize
        async function init() {
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                // Register as user
                socket.emit('register', 'user');
                updateStatus('âœ… Connected. Waiting for model...');
                
                // Setup WebRTC listeners
                setupWebRTC();
            } catch (err) {
                console.error('Error accessing media:', err);
                updateStatus('âŒ Error accessing camera/microphone');
            }
        }
        
        function setupWebRTC() {
            socket.on('partner-found', (partnerId) => {
                updateStatus('ğŸ¯ Model found! Starting call...');
                createPeerConnection();
                startCall();
            });
            
            socket.on('offer', async (data) => {
                if (!peerConnection) createPeerConnection();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', { answer: answer, target: data.sender });
            });
            
            socket.on('answer', async (data) => {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            });
            
            socket.on('ice-candidate', async (candidate) => {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.error('Error adding ICE candidate:', e);
                }
            });
            
            socket.on('partner-disconnected', () => {
                updateStatus('ğŸ“ Model disconnected');
                endCall();
            });
        }
        
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Get remote stream
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
                updateStatus('âœ… Call connected! You can see and hear each other.');
                isCallActive = true;
            };
            
            // ICE candidate handling
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        target: users[socket.id]?.partner
                    });
                }
            };
        }
        
        async function startCall() {
            if (!peerConnection) createPeerConnection();
            
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            const partnerId = users[socket.id]?.partner;
            if (partnerId) {
                socket.emit('offer', { offer: offer, target: partnerId });
                updateStatus('ğŸ“ Calling model...');
            }
        }
        
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                document.getElementById('remoteVideo').srcObject = null;
            }
            isCallActive = false;
            updateStatus('ğŸ“ Call ended. Waiting for new model...');
        }
        
        function toggleMute() {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                updateStatus(audioTrack.enabled ? 'ğŸ¤ Mic unmuted' : 'ğŸ”‡ Mic muted');
            }
        }
        
        function toggleVideo() {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                updateStatus(videoTrack.enabled ? 'ğŸ“· Camera on' : 'ğŸ“· Camera off');
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>
