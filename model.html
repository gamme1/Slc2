<!DOCTYPE html>
<html>
<head>
    <title>SolCam - Model Dashboard</title>
    <style>
        body { background: #0f172a; color: white; text-align: center; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .video-container { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
        video { width: 100%; max-width: 600px; border: 3px solid #ec4899; border-radius: 10px; }
        #localVideo { width: 200px; height: 150px; position: absolute; bottom: 20px; right: 20px; border: 2px solid #8b5cf6; }
        .controls { margin: 20px; }
        button { 
            background: linear-gradient(to right, #8b5cf6, #ec4899); 
            color: white; border: none; padding: 12px 25px; 
            border-radius: 8px; margin: 10px; font-weight: bold; cursor: pointer;
        }
        button:hover { opacity: 0.9; }
        .status { padding: 10px; background: #1e293b; border-radius: 8px; margin: 10px; }
        h1 { color: #ec4899; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Model Dashboard</h1>
        <div class="status" id="status">Setting up your camera...</div>
        
        <div class="video-container">
            <div>
                <h3>ğŸ‘¤ User's Camera</h3>
                <video id="remoteVideo" autoplay playsinline></video>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="goLive()">ğŸ¬ GO LIVE NOW</button>
            <button onclick="toggleMute()">ğŸ”‡ Toggle Mic</button>
            <button onclick="toggleVideo()">ğŸ“· Toggle Camera</button>
            <button onclick="endCall()" style="background:#ef4444;">âŒ End Call</button>
        </div>
        
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let localStream;
        let remoteStream;
        let peerConnection;
        let isLive = false;
        
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };
        
        async function init() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 },
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
                
                socket.emit('register', 'model');
                updateStatus('âœ… Ready to go live!');
                
                setupWebRTC();
            } catch (err) {
                console.error('Error:', err);
                updateStatus('âŒ Camera/mic access denied');
            }
        }
        
        function setupWebRTC() {
            socket.on('partner-found', (partnerId) => {
                updateStatus('ğŸ¯ User connected! Starting call...');
                createPeerConnection();
                goLive();
            });
            
            socket.on('offer', async (data) => {
                if (!peerConnection) createPeerConnection();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('answer', { answer: answer, target: data.sender });
            });
            
            socket.on('answer', async (data) => {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
            });
            
            socket.on('ice-candidate', async (candidate) => {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (e) {
                    console.error('Error:', e);
                }
            });
            
            socket.on('partner-disconnected', () => {
                updateStatus('ğŸ“ User disconnected');
                endCall();
            });
        }
        
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
                updateStatus('âœ… You are LIVE! User can see and hear you.');
                isLive = true;
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        target: users[socket.id]?.partner
                    });
                }
            };
        }
        
        async function goLive() {
            if (!isLive) {
                if (!peerConnection) createPeerConnection();
                
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                const partnerId = users[socket.id]?.partner;
                if (partnerId) {
                    socket.emit('offer', { offer: offer, target: partnerId });
                    updateStatus('ğŸ“ Connecting to user...');
                }
            }
        }
        
        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (remoteStream) {
                remoteStream.getTracks().forEach(track => track.stop());
                document.getElementById('remoteVideo').srcObject = null;
            }
            isLive = false;
            updateStatus('ğŸ“ Call ended. Ready for next user...');
        }
        
        function toggleMute() {
            const audioTrack = localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                updateStatus(audioTrack.enabled ? 'ğŸ¤ Mic on' : 'ğŸ”‡ Mic muted');
            }
        }
        
        function toggleVideo() {
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                updateStatus(videoTrack.enabled ? 'ğŸ“· Camera on' : 'ğŸ“· Camera off');
            }
        }
        
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        window.onload = init;
    </script>
</body>
</html>
